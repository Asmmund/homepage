
task  :homepage do
  set :application, 'elmor.org.ua'
  require 'bundler/capistrano'
  require 'capistrano-unicorn'

set :default_environment, {
    'PATH' => "/usr/local/bin:/bin:/usr/bin:/bin:/home/h41319/data/.rvm/rubies/ruby-1.9.3-p385/bin/ruby/bin: /usr/local/rvm/rubies/ruby-1.9.3-p385/bin/lib",
    'GEM_HOME' => '/home/h41319/data/.rvm/rubies/ruby-1.9.3-p385/bin/lib/gems/ruby-1.9.3-p385',
    'GEM_PATH' => '/home/h41319/data/.rvm/rubies/ruby-1.9.3-p385/bin/lib/gems/ruby-1.9.3-p385',
    'BUNDLE_PATH' => '/home/h41319/data/.rvm/rubies/ruby-1.9.3-p385/bin/lib/gems/ruby-1.9.3-p385/gems'
}
set :rvm_ruby_string, ENV['GEM_HOME'].gsub(/.*\//,"")
set :rvm_install_ruby_params, '--1.9'      # for jruby/rbx default to 1.9 mode
set :rvm_install_pkgs, %w[libyaml openssl] # package list from https://rvm.io/packages
set :rvm_install_ruby_params, '--with-opt-dir=/usr/local/rvm/usr' # package support

before 'deploy:setup', 'rvm:install_rvm'   # install RVM
before 'deploy:setup', 'rvm:install_pkgs'  # install RVM packages before Ruby
before 'deploy:setup', 'rvm:install_ruby'  # install Ruby and create gemset, or:
before 'deploy:setup', 'rvm:create_gemset' # only create gemset
before 'deploy:setup', 'rvm:import_gemset' # import gemset from file
require "rvm/capistrano"

  # setting up params
  set :user, 'h41319'
  set :use_sudo, false
  set :domain, 'elmor.org.ua'
  set :deploy_server, 'h33.hvosting.ua'
  set :applicationdir, "/home/h41319/data/www/#{domain}"
  set :scm, 'git'
  set :repository,  "git@github.com:Asmmund/homepage.git"
  set :git_enable_submodules, 1 # if you have vendored rails
  set :branch, 'master'
  set :git_shallow_clone, 1
  set :scm_verbose, true

  after 'deploy:restart', 'unicorn:restart'
  after "deploy:update_code", :copy_database_config
  task :copy_database_config, roles => :app do
    db_config = "#{shared_path}/config/database.yml"
    run "cp #{db_config} #{release_path}/config/database.yml"
  end



set :rvm_ruby_string, '1.9.3'
    # set :rvm_ruby_string, "1.9.3"
    # set :rake,            "rvm use #{rvm_ruby_string} do bundle exec rake"
    # set :bundle_cmd,      "rvm use #{rvm_ruby_string} do bundle"

  # after "deploy:update_code", :set_bundler
  # task :set_bundler, roles => :app do
  #   run "#{bundle_cmd}"
  # end

  # assigning all roles to one server
  server deploy_server, :app, :web, :db, :primary => true
  ssh_options[:forward_agent] = true
  on :start do
    `ssh-add`
  end

  # deploy config
  set :deploy_to, applicationdir
  # set :deploy_via, :remote_cache
  after 'deploy:update_code', 'deploy:migrate'
  # additional settings
  default_run_options[:pty] = true  # Forgo errors when deploying from windows
  #ssh_options[:keys] = %w(/home/user/.ssh/id_rsa)
  # If 3ou are using ssh_keysset :chmod755, "app config db lib public vendor script script/* public/disp*"

  set :keep_releases, 5
  after "deploy:restart", "deploy:cleanup"

end
